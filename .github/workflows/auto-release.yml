name: Release from PR Title

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  create_release:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true && 
      startsWith(github.event.pull_request.title, 'Release (PROD): v')
    permissions:
      contents: write # Allows the job to create the release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for git history (release notes)

      # ------------------------------------------------------------------
      # 1. BUILD YOUR PROJECT
      # ------------------------------------------------------------------
      - name: Install dependencies & build
        run: |
          # Example for a Node.js project – replace with your own commands
          npm ci
          npm run build          # this must create the ./build folder

      # ------------------------------------------------------------------
      # 2. ZIP THE BUILD FOLDER
      # ------------------------------------------------------------------
      - name: Zip build folder
        run: |
          zip -r build.zip build/

      # ------------------------------------------------------------------
      # 3. EXTRACT VERSION
      # ------------------------------------------------------------------
      - name: Extract version from PR title
        id: extract_version
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          VERSION=$(echo "$PR_TITLE" | sed -E 's/Release \(PROD\): (v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "Extracted Version: $VERSION"
          echo "release_version=$VERSION" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 4. CREATE RELEASE + UPLOAD build.zip (only new `files:` line)
      # ------------------------------------------------------------------
      - name: Create GitHub Release with auto-generated notes
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract_version.outputs.release_version }}
          name: ${{ steps.extract_version.outputs.release_version }}
          # This tells GitHub to automatically generate the notes based on merged PRs/commits since the last release
          generate_release_notes: true
          # You can still add a prefix/suffix to the generated body if you like:
          files: |
            build.zip          # NEW – adds the zip as an extra asset
