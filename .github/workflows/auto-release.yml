name: Release from PR Title

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  create_release:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true && 
      startsWith(github.event.pull_request.title, 'Release (PROD): v')
    permissions:
      contents: write # Allows the job to create the release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for git history (release notes)

      # ------------------------------------------------------------------
      # 1. BUILD YOUR PROJECT
      # ------------------------------------------------------------------
      - name: Install dependencies & build
        continue-on-error: true
        run: |
          npm ci
          npm run build

      - name: List files after build (DEBUG)
        run: |
          echo "Current directory:"
          pwd
          echo "Files in root:"
          ls -la
          echo "Does 'build' folder exist?"
          if [ -d "build" ]; then
            echo "YES! Contents of build/:"
            ls -la build/
          else
            echo "NO! build/ folder missing."
            echo "Available folders:"
            find . -maxdepth 2 -type d
          fi

      - name: Zip build folder
        continue-on-error: true
        run: |
          if [ -d "build" ]; then
            zip -r build.zip build/
            echo "build.zip created successfully"
          else
            echo "WARNING: build/ folder not found! Release will be created without build artifact."
          fi
      # ------------------------------------------------------------------
      # 3. EXTRACT VERSION
      # ------------------------------------------------------------------
      - name: Extract version from PR title
        id: extract_version
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          VERSION=$(echo "$PR_TITLE" | sed -E 's/Release \(PROD\): (v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "Extracted Version: $VERSION"
          echo "release_version=$VERSION" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 3.5. EXTRACT PR DESCRIPTION
      # ------------------------------------------------------------------
      - name: Extract PR description
        id: extract_description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          # Store PR description for later use
          echo "pr_description<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 4. CREATE RELEASE + UPLOAD build.zip (conditional)
      # ------------------------------------------------------------------
      - name: Check if build.zip exists
        id: check_build
        run: |
          if [ -f "build.zip" ]; then
            echo "build_exists=true" >> $GITHUB_OUTPUT
          else
            echo "build_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release with build artifact (if build succeeded)
        if: steps.check_build.outputs.build_exists == 'true'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract_version.outputs.release_version }}
          name: ${{ steps.extract_version.outputs.release_version }}
          body: |
            ${{ steps.extract_description.outputs.pr_description }}
          generate_release_notes: true
          files: |
            build.zip

      - name: Create GitHub Release without build artifact (if build failed)
        if: steps.check_build.outputs.build_exists == 'false'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract_version.outputs.release_version }}
          name: ${{ steps.extract_version.outputs.release_version }}
          body: |
            ${{ steps.extract_description.outputs.pr_description }}
          generate_release_notes: true
